# Plan: 마이크로-리스크 (Micro Risk Loop)

## Feature Overview
- **Feature Name**: 마이크로-리스크
- **Phase**: 5/6 (Architecture Sub-document Pipeline)
- **Source**: `docs/arch/sub/16_Micro_Risk_Loop_Architecture.md`
- **Priority**: Critical (ETEDA 독립 리스크 제어)

## Background
ETEDA 사이클(500ms~3s)보다 빠른 100ms~1s 주기의 독립적 리스크 제어 루프.
트레일링 스탑, MAE, 보유시간, 변동성 킬스위치 등 초고속 리스크 규칙 실행.

## Scope

### In Scope
1. PositionShadow 상태 관리 (sync_fields + local_fields)
2. PriceFeedHandler (가격 버퍼, 이상 감지)
3. RiskRuleEvaluator (4개 규칙 우선순위 순서 평가)
4. ActionDispatcher (6개 액션 타입 디스패치)
5. MicroRiskLoop 컨트롤러 (동기식 테스트 가능)
6. Guardrails: FS100-FS105, GR070-GR074
7. Safety Layer 연계 (SafetyStateManager)

### Out of Scope
- 실제 비동기 이벤트 루프 (Thread/asyncio 실행)
- 실시간 브로커 연동
- Redis 캐시 통합

## Technical Approach
- Phase 4 (스캘프-실행)과 동일한 동기식 테스트 가능 설계
- Protocol 기반 외부 의존성 주입
- Decimal 기반 금융 계산
- 기존 SafetyState, EventType 재사용

## Implementation Order
1. contracts.py — 데이터 계약 (PositionShadow, PriceFeed, MarketData, configs)
2. shadow_manager.py — Position Shadow Manager
3. price_handler.py — Price Feed Handler
4. rules/ — 4개 리스크 규칙 (TrailingStop, MAE, TimeInTrade, VolatilityKillSwitch)
5. evaluator.py — Rule Evaluator (우선순위 순서 평가)
6. dispatcher.py — Action Dispatcher
7. guardrails.py — FS100-105, GR070-074
8. loop.py — Micro Risk Loop Controller

## Dependencies
- `src/safety/state.py` — SafetyState, SafetyStateManager
- `src/safety/codes.py` — FS100, GR070 (reserved)
- `src/event/contracts.py` — EventType, EventPriority, create_event
- `src/provider/models/order_request.py` — OrderSide

## Success Criteria
- 단위 테스트: 규칙별 10+ 케이스
- 통합 테스트: 전체 루프 사이클, Safety 연계
- Gap Analysis >= 90%
- 기존 테스트 회귀 없음
