# Design: 마이크로-리스크 (Micro Risk Loop)

## Architecture Reference
- Source: `docs/arch/sub/16_Micro_Risk_Loop_Architecture.md`

## Package Structure
```
src/micro_risk/
    __init__.py
    contracts.py        # 데이터 계약
    shadow_manager.py   # Position Shadow Manager
    price_handler.py    # Price Feed Handler
    rules/
        __init__.py
        base.py             # RiskRule Protocol
        trailing_stop.py    # TrailingStopRule
        mae.py              # MAERule
        time_in_trade.py    # TimeInTradeRule
        volatility.py       # VolatilityKillSwitchRule
    evaluator.py        # RiskRuleEvaluator
    dispatcher.py       # ActionDispatcher
    guardrails.py       # FS100-105, GR070-074
    loop.py             # MicroRiskLoop Controller
```

## 1. Data Contracts (`contracts.py`)

### 1.1 PositionShadow
```python
@dataclass
class PositionShadow:
    symbol: str
    qty: int
    avg_price: Decimal
    current_price: Decimal
    unrealized_pnl: Decimal = Decimal("0")
    unrealized_pnl_pct: Decimal = Decimal("0")
    # Local fields (Micro Loop only)
    entry_time: datetime
    time_in_trade_sec: int = 0
    highest_price_since_entry: Decimal
    lowest_price_since_entry: Decimal
    mae_pct: Decimal = Decimal("0")
    mfe_pct: Decimal = Decimal("0")
    trailing_stop_active: bool = False
    trailing_stop_price: Decimal = Decimal("0")
    last_sync_time: datetime
    strategy: str = "SCALP"  # SCALP/SWING/PORTFOLIO
```

### 1.2 PriceFeed
```python
@dataclass(frozen=True)
class PriceFeed:
    symbol: str
    price: Decimal
    bid: Decimal
    ask: Decimal
    volume: int
    timestamp: datetime
    source: str = "BROKER_KIS"
```

### 1.3 MarketData
```python
@dataclass
class MarketData:
    vix: Decimal = Decimal("20")
    realized_volatility: Decimal = Decimal("0.02")
    timestamp: datetime
```

### 1.4 MicroRiskAction
```python
class ActionType(str, Enum):
    TRAILING_STOP_ADJUST = "TRAILING_STOP_ADJUST"
    PARTIAL_EXIT = "PARTIAL_EXIT"
    FULL_EXIT = "FULL_EXIT"
    POSITION_FREEZE = "POSITION_FREEZE"
    ETEDA_SUSPEND = "ETEDA_SUSPEND"
    KILL_SWITCH = "KILL_SWITCH"

@dataclass(frozen=True)
class MicroRiskAction:
    action_type: ActionType
    symbol: str
    payload: dict
    priority: str = "P0"
```

### 1.5 Config Dataclasses
- TrailingStopConfig: activation_profit_pct, trail_distance_pct, min_trail_distance, ratchet_only
- MAEConfig: position_mae_threshold_pct, partial_exit_at_pct, partial_exit_ratio
- TimeInTradeConfig: scalp_max_time_sec, warning_at_pct, extension_conditions
- VolatilityKillSwitchConfig: vix_warning/critical/kill_level, realized_vol_warning/critical/kill
- MicroRiskConfig: loop_interval_ms, max_positions_monitored, all sub-configs

## 2. Position Shadow Manager (`shadow_manager.py`)

### 2.1 Sync Fields vs Local Fields
- sync_fields: qty, avg_price, current_price, unrealized_pnl, unrealized_pnl_pct
- local_fields: time_in_trade_sec, highest/lowest_price, mae/mfe_pct, trailing_stop_*

### 2.2 Operations
- `sync_from_main(positions)` — Non-blocking sync of sync_fields
- `update_extremes(symbol, price)` — 고가/저가 업데이트
- `update_pnl(symbol)` — PnL 재계산
- `add_position(shadow)` / `remove_position(symbol)`
- `get(symbol)` / `items()` / `has_position(symbol)`

## 3. Price Feed Handler (`price_handler.py`)

### 3.1 Price Buffer
- deque per symbol (maxlen=100)
- `on_price_tick(feed)` — 가격 추가 + shadow 업데이트
- `is_price_stale(symbol, threshold_ms=500)` — Stale 감지
- `detect_anomaly(symbol, new_price, threshold_pct=0.05)` — 이상 감지
- `get_latest(symbol)` — 최신 PriceFeed 반환

## 4. Risk Rules (`rules/`)

### 4.1 Base Protocol
```python
class RiskRule(Protocol):
    def evaluate(self, shadow: PositionShadow, market_data: MarketData) -> Optional[MicroRiskAction]: ...
```

### 4.2 TrailingStopRule
- 활성화: unrealized_pnl_pct >= activation_profit_pct
- 스탑 계산: highest * (1 - trail_distance_pct), 최소 거리 보장, ratchet (위로만)
- 트리거: current_price <= trailing_stop_price → FULL_EXIT
- 조정: new_stop > old_stop → TRAILING_STOP_ADJUST

### 4.3 MAERule
- MAE 계산: (lowest - avg_price) / avg_price (Long)
- 전량 청산: |mae_pct| >= position_mae_threshold_pct → FULL_EXIT
- 부분 청산: |mae_pct| >= partial_exit_at_pct → PARTIAL_EXIT

### 4.4 TimeInTradeRule
- 시간 초과: time_in_trade_sec >= max_time → FULL_EXIT
- 연장: 수익 중이면 extension_time_sec 추가
- 전략별 max_time: SCALP=3600s, SWING=604800s, PORTFOLIO=None

### 4.5 VolatilityKillSwitchRule (최우선)
- Kill: vix >= 40 or vol >= 8% → KILL_SWITCH (symbol="ALL")
- Critical: vix >= 30 or vol >= 5% → PARTIAL_EXIT (50%)
- Warning: vix >= 25 → log only (None 반환)

## 5. Evaluator (`evaluator.py`)

### 5.1 평가 순서
1. VolatilityKillSwitch (최우선)
2. MAE
3. TimeInTrade
4. TrailingStop

### 5.2 단락 평가
- KILL_SWITCH 또는 FULL_EXIT 반환 시 나머지 규칙 스킵

## 6. Dispatcher (`dispatcher.py`)

### 6.1 Protocol Dependencies
```python
class EmergencyOrderChannel(Protocol):
    def send_emergency_order(self, symbol, side, qty, order_type, reason) -> bool: ...

class ETEDAController(Protocol):
    def suspend(self, reason, source, duration_ms) -> bool: ...
    def is_suspended(self) -> bool: ...

class SafetyNotifier(Protocol):
    def notify(self, code, message) -> None: ...
```

### 6.2 Dispatch Logic
- TRAILING_STOP_ADJUST → shadow 직접 업데이트
- PARTIAL_EXIT → EmergencyOrderChannel + shadow qty 감소
- FULL_EXIT → EmergencyOrderChannel + trailing_stop 비활성화
- POSITION_FREEZE → freeze set 관리
- ETEDA_SUSPEND → ETEDAController.suspend()
- KILL_SWITCH → 전량 청산 + ETEDA 정지 + Safety 통보 (FS104)

## 7. Guardrails (`guardrails.py`)

### 7.1 Fail-Safe (FS100-FS105)
| Code | Condition | Action |
|------|-----------|--------|
| FS100 | Loop crash/error | 에러 로그, 복구 시도 |
| FS101 | Sync delay > 1s | 경고, stale 플래그 |
| FS102 | Emergency exit executed | Safety 통보 |
| FS103 | ETEDA suspend request | Safety 통보 |
| FS104 | Kill switch activated | 전량 청산, LOCKDOWN |
| FS105 | Price feed interrupted | 경고, 최종 가격 사용 |

### 7.2 Guardrails (GR070-GR074)
| Code | Condition | Action |
|------|-----------|--------|
| GR070 | Trailing stop excessive adjustment | 빈도 제한 |
| GR071 | MAE threshold approaching | 경고 |
| GR072 | Time-in-trade warning | 경고 |
| GR073 | Volatility rising | 포지션 축소 권고 |
| GR074 | Emergency order failure | 재시도 + FS 에스컬레이션 |

## 8. Loop Controller (`loop.py`)

### 8.1 MicroRiskLoop
- 동기식 `run_cycle()` 메서드 (테스트 가능)
- `start()` / `stop()` — 루프 제어
- 사이클: sync → evaluate → dispatch → sleep
- 에러 핸들링: 에러 시 FS100 발생, 연속 3회 시 ETEDA 정지

## 9. Test Plan

### 9.1 Unit Tests
- test_contracts.py — PositionShadow, PriceFeed, configs, ActionType
- test_shadow_manager.py — sync, extremes, PnL update, add/remove
- test_price_handler.py — tick, buffer, stale, anomaly
- test_trailing_stop.py — activation, calculation, trigger, ratchet, adjust
- test_mae.py — calculation, threshold, partial, zero price
- test_time_in_trade.py — timeout, extension, strategy-specific, warning
- test_volatility.py — kill/critical/warning levels, combined
- test_evaluator.py — priority order, short-circuit, multiple actions
- test_guardrails.py — all FS100-105, GR070-074

### 9.2 Integration Tests
- test_micro_risk_integration.py — full cycle, safety escalation, ETEDA independence
