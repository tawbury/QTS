# Design: 피드백-루프 (Feedback Loop)

## Architecture Reference
- Source: `docs/arch/sub/20_Feedback_Loop_Architecture.md`

## Package Structure
```
src/feedback/
    __init__.py
    contracts.py        # 데이터 계약
    slippage.py         # Slippage 계산
    quality.py          # Execution Quality Score
    impact.py           # Market Impact Estimation
    aggregator.py       # FeedbackAggregator
    strategy_enhancer.py # Strategy Enhancement
    kpi.py              # KPI 기준값 및 평가
```

## 1. Data Contracts (`contracts.py`)

### 1.1 TickRecord
```python
@dataclass(frozen=True)
class TickRecord:
    timestamp: datetime
    symbol: str
    price: Decimal
    volume: int
    side: str  # BID / ASK / TRADE
```

### 1.2 FeedbackData
```python
@dataclass
class FeedbackData:
    symbol: str
    execution_start: datetime
    execution_end: datetime
    feedback_generated_at: datetime
    scalp_ticks: list[TickRecord]
    total_slippage_bps: float
    avg_fill_latency_ms: float
    partial_fill_ratio: float
    total_filled_qty: Decimal
    avg_fill_price: Decimal
    volatility_at_execution: float
    spread_at_execution: Decimal
    depth_at_execution: int
    execution_quality_score: float
    market_impact_bps: float
    strategy_tag: str
    order_type: str
    original_qty: Decimal
```

### 1.3 FeedbackSummary
```python
@dataclass(frozen=True)
class FeedbackSummary:
    avg_slippage_bps: float = 10.0       # Conservative default
    avg_market_impact_bps: float = 15.0
    avg_quality_score: float = 0.75
    sample_count: int = 0

DEFAULT_FEEDBACK_SUMMARY = FeedbackSummary()
```

### 1.4 Configs
```python
@dataclass(frozen=True)
class FeedbackConfig:
    lookback_days: int = 30
    min_samples: int = 5
    max_acceptable_impact_bps: float = 20.0

@dataclass(frozen=True)
class KPIThresholds:
    max_avg_slippage_bps: float = 10.0
    min_quality_score: float = 0.85
    min_fill_ratio: float = 0.95
    max_avg_latency_ms: float = 100.0
    max_avg_impact_bps: float = 15.0
```

## 2. Slippage Calculation (`slippage.py`)

### 2.1 calculate_slippage_bps
```python
def calculate_slippage_bps(
    decision_price: Decimal,
    avg_fill_price: Decimal
) -> float:
    """(avg_fill_price - decision_price) / decision_price * 10000"""
```
- decision_price == 0 → return 0.0
- 양수 = 불리한 방향, 음수 = 유리한 방향

## 3. Execution Quality Score (`quality.py`)

### 3.1 calculate_execution_quality_score
```python
def calculate_execution_quality_score(
    total_slippage_bps: float,
    partial_fill_ratio: float,
    avg_fill_latency_ms: float
) -> float:
```
- Slippage Score: 1.0 - min(|slippage| / 50, 1.0) → weight 0.5
- Fill Score: 1.0 - partial_fill_ratio → weight 0.3
- Latency Score: 1.0 - min(latency / 1000, 1.0) → weight 0.2
- 결과: 0.0 ~ 1.0

## 4. Market Impact Estimation (`impact.py`)

### 4.1 estimate_market_impact_bps
```python
def estimate_market_impact_bps(
    order_qty: Decimal,
    avg_daily_volume: int,
    spread_bps: float
) -> float:
```
- participation_rate = order_qty / avg_daily_volume
- impact = spread_bps * sqrt(participation_rate) * 10
- avg_daily_volume == 0 → return 0.0

## 5. FeedbackAggregator (`aggregator.py`)

### 5.1 Protocol Dependencies
```python
class FeedbackDBAdapter(Protocol):
    def fetch_tick_data(self, symbol, start, end) -> list[TickRecord]: ...
    def fetch_avg_daily_volume(self, symbol) -> int: ...
    def store_feedback(self, feedback: FeedbackData) -> None: ...
    def fetch_feedback_summary(self, symbol, lookback_days) -> Optional[FeedbackSummary]: ...
```

### 5.2 FeedbackAggregator
- `aggregate(execution_result, decision_price, fills, ticks, market_context)` → FeedbackData
- 동기식 메서드 (테스트 가능)
- slippage, quality, impact 계산을 내부 호출
- market_context: volatility, spread, depth

### 5.3 MarketContext
```python
@dataclass(frozen=True)
class MarketContext:
    volatility: float = 0.0
    spread_bps: Decimal = Decimal("0")
    depth: int = 0
    avg_daily_volume: int = 0
```

## 6. Strategy Enhancer (`strategy_enhancer.py`)

### 6.1 calculate_adjusted_entry_price
```python
def calculate_adjusted_entry_price(
    signal_price: Decimal,
    historical_slippage_bps: float,
    side: str  # BUY / SELL
) -> Decimal:
```
- BUY: signal_price * (1 + slippage_factor)
- SELL: signal_price * (1 - slippage_factor)

### 6.2 adjust_qty_for_market_impact
```python
def adjust_qty_for_market_impact(
    target_qty: Decimal,
    estimated_impact_bps: float,
    max_acceptable_impact_bps: float = 20.0
) -> Decimal:
```
- impact <= max → return target_qty
- impact > max → reduce by ratio max/estimated

### 6.3 adjust_confidence
```python
def adjust_confidence(
    raw_confidence: float,
    quality_score: float
) -> float:
```
- return raw_confidence * quality_score (0.0 ~ 1.0 clamped)

## 7. KPI (`kpi.py`)

### 7.1 KPIResult
```python
@dataclass
class KPIResult:
    metric: str
    value: float
    threshold: float
    passed: bool
```

### 7.2 evaluate_kpis
```python
def evaluate_kpis(
    summary: FeedbackSummary,
    thresholds: KPIThresholds
) -> list[KPIResult]:
```
- 5개 KPI 평가: slippage, quality, fill_ratio, latency, impact
- FeedbackSummary에 avg_latency_ms, avg_fill_ratio 추가 필요

## 8. Test Plan

### 8.1 Unit Tests
- test_contracts.py — TickRecord, FeedbackData, FeedbackSummary, configs
- test_slippage.py — 정상, zero price, negative slippage
- test_quality.py — 가중 평균, 경계값, 극단값
- test_impact.py — 정상, zero volume, large order
- test_aggregator.py — aggregate, market context
- test_strategy_enhancer.py — 보정가 계산, 수량 조정, confidence
- test_kpi.py — KPI 평가, pass/fail 판정

### 8.2 Integration Tests
- test_feedback_integration.py — 전체 피드백 루프 (ExecutionResult → FeedbackData → Strategy Enhancement)
