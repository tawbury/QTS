# Plan: 데이터 인프라 (Phase 2)

> 아키텍처 고도화 Phase 2: Data Layer + Caching 구현

## 1. 개요

### 1.1 목표
QTS의 데이터 접근 계층을 추상화하여 Google Sheets 외에 PostgreSQL/TimescaleDB, Redis를 지원하도록 확장한다.
기존 Google Sheets 기반 시스템을 유지하면서 점진적 마이그레이션 경로를 제공한다.

### 1.2 근거 문서
- `docs/arch/sub/18_Data_Layer_Architecture.md` (Data Layer)
- `docs/arch/sub/19_Caching_Architecture.md` (Caching)

### 1.3 선행 조건
- Phase 1 (Event Priority + System State) 완료 (93% Match Rate, Archived)

## 2. 범위

### 2.1 포함
- DataSourceAdapter 추상 인터페이스 정의
- 데이터 계약 (Position, LedgerEntry, OHLCV, TickData)
- TimescaleDBAdapter 구현 (asyncpg 기반)
- HybridAdapter 구현 (Dual-Write)
- InMemoryAdapter 구현 (테스트용)
- CacheManager + CacheClient 추상 인터페이스
- 6가지 캐시 타입 정의 (Price/Position/Orderbook/Risk/Order/Strategy)
- InMemoryCacheClient 구현 (테스트용)
- Circuit Breaker 패턴
- Stale Data Detection
- Phase 1 Event/State 시스템과 통합

### 2.2 제외
- 실제 PostgreSQL/Redis 인프라 구축 (DevOps 영역)
- 데이터 마이그레이션 실행 (별도 Phase)
- Redis Cluster 구성 (운영 영역)

## 3. 구현 계획

### Phase 2-A: Data Layer (src/db/adapters/)

#### 3.1 데이터 계약 정의
- `src/db/contracts.py` — Position, LedgerEntry, OHLCV, TickData dataclass
- 기존 Google Sheets 데이터 형식과 호환

#### 3.2 DataSourceAdapter 인터페이스
- `src/db/adapters/interface.py` — 추상 인터페이스
  - fetch_positions() → List[Position]
  - update_position(symbol, qty, avg_price)
  - append_ledger(entry) → bool
  - fetch_ohlcv(symbol, start, end, interval) → List[OHLCV]
  - fetch_tick_data(symbol, start, end) → List[TickData]
  - health_check() → HealthStatus

#### 3.3 어댑터 구현
- `src/db/adapters/memory.py` — InMemoryAdapter (테스트/개발용)
- `src/db/adapters/timescale.py` — TimescaleDBAdapter (asyncpg)
- `src/db/adapters/hybrid.py` — HybridAdapter (Dual-Write)

#### 3.4 설정
- `src/db/adapters/config.py` — DataSourceMode(SHEETS_ONLY/HYBRID/DB_ONLY), ConnectionConfig

### Phase 2-B: Caching Layer (src/cache/)

#### 3.5 캐시 계약 정의
- `src/cache/contracts.py` — CacheType enum, CacheConfig, TTL 설정

#### 3.6 CacheClient 인터페이스
- `src/cache/interface.py` — 추상 인터페이스
  - get(key) → Optional[dict]
  - set(key, value, ttl) → bool
  - delete(key) → bool
  - hset/hget/hgetall
  - pipeline() → Pipeline
  - health_check() → HealthStatus

#### 3.7 캐시 구현
- `src/cache/memory.py` — InMemoryCacheClient (테스트용, TTL 지원)
- `src/cache/redis_client.py` — RedisCacheClient (redis.asyncio)
- `src/cache/manager.py` — CacheManager (Cache-Aside, Write-Through, Circuit Breaker)
- `src/cache/circuit_breaker.py` — CircuitBreaker (5회 실패 → 60s 복구)

### Phase 2-C: 통합

#### 3.8 Event System 통합
- Cache miss/hit 이벤트를 P3_LOW로 기록
- Circuit Breaker 상태 변경을 P1_HIGH 이벤트로 발행

#### 3.9 Safety 통합
- Safety LOCKDOWN 시 캐시 쓰기 중단
- Safety FAIL 시 캐시 Fallback 강제

## 4. 테스트 전략

| 범주 | 테스트 | 위치 |
|------|--------|------|
| 계약 | 데이터 계약 필드, 변환 | `tests/unit/db/test_contracts.py` |
| 어댑터 | InMemory CRUD, 쿼리 | `tests/unit/db/test_adapters.py` |
| 캐시 계약 | CacheType, TTL 설정 | `tests/unit/cache/test_contracts.py` |
| 캐시 클라이언트 | InMemory, TTL, pipeline | `tests/unit/cache/test_memory.py` |
| 캐시 관리자 | Cache-Aside, Write-Through | `tests/unit/cache/test_manager.py` |
| Circuit Breaker | 상태 전이, 복구 | `tests/unit/cache/test_circuit_breaker.py` |
| 통합 | 어댑터 + 캐시 + 이벤트 | `tests/integration/test_data_cache.py` |

## 5. 성공 기준

- [ ] DataSourceAdapter 인터페이스 정의 완료
- [ ] InMemoryAdapter 모든 CRUD 테스트 통과
- [ ] 6가지 캐시 타입 정의 완료
- [ ] InMemoryCacheClient TTL 동작 확인
- [ ] Circuit Breaker 상태 전이 테스트 통과
- [ ] CacheManager Cache-Aside 패턴 테스트 통과
- [ ] Event/Safety 통합 테스트 통과
- [ ] PDCA Check ≥ 90% Match Rate

## 6. 산출물

| 패키지 | 파일 수 (예상) |
|--------|-------------|
| `src/db/contracts.py` | 1 |
| `src/db/adapters/` | 5 (init, interface, memory, timescale, hybrid, config) |
| `src/cache/` | 6 (init, contracts, interface, memory, redis_client, manager, circuit_breaker) |
| `tests/unit/db/` | 2 |
| `tests/unit/cache/` | 4 |
| `tests/integration/` | 1 |
