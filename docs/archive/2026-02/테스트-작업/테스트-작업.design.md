# Design: 테스트 작업

> PDCA Phase: **Design**
> Feature: 테스트 작업
> Created: 2026-02-11
> Status: Draft
> Plan Reference: `docs/01-plan/features/테스트-작업.plan.md`

---

## 1. 설계 개요 (Design Overview)

QTS 프로젝트의 테스트 체계를 분석하고 보강하기 위한 설계 문서.
현재 96개 이상의 테스트 파일이 존재하며, 17개 소스 패키지를 대상으로 한다.

### 현재 상태 요약

| 항목 | 현황 |
|------|------|
| 테스트 파일 수 | 96+ files |
| 소스 패키지 수 | 17 packages |
| conftest.py | 3개 (root, api, broker) |
| Mock 구현 | brokers, db, pipeline |
| 테스트 카테고리 | api, config, contracts, engines, integration, ops, runtime, unit |

## 2. 아키텍처 설계 (Architecture Design)

### 2.1 테스트 피라미드

```
         ╱╲
        ╱ E2E ╲          ← tests/integration/, tests/runtime/integration/
       ╱────────╲            (ETEDA 전체 파이프라인, 브로커 연동)
      ╱ Integration╲      ← tests/runtime/execution*, tests/ops/
     ╱──────────────╲        (엔진 간 연동, Safety-Pipeline 통합)
    ╱   Unit Tests    ╲    ← tests/engines/, tests/unit/, tests/runtime/{module}/
   ╱────────────────────╲    (개별 엔진, 계산기, 게이트, 유틸)
  ╱    Contract Tests     ╲ ← tests/contracts/
 ╱──────────────────────────╲  (레이어 간 계약 검증)
```

### 2.2 테스트 디렉토리 ↔ 소스 매핑

| 소스 패키지 | 테스트 디렉토리 | 커버리지 상태 |
|------------|----------------|-------------|
| `src/strategy/` | `tests/runtime/strategy/` | 3 files (registry, multiplexer, simple) |
| `src/risk/` | `tests/runtime/risk/` | 3 files (calculator, gates x2) |
| `src/safety/` | `tests/ops/safety/` | 5 files (codes, guard, layer, notifier, state) |
| `src/pipeline/` | `tests/runtime/execution_loop/` | 2 files (eteda loop, integration) |
| `src/provider/` | `tests/runtime/broker/` | 8 files (factory, adapters, auth, orders) |
| `src/db/` | `tests/runtime/data/`, `tests/google_sheets_integration/` | 9 files |
| `src/monitoring/` | `tests/runtime/monitoring/` | 2 files (logger, metrics) |
| `src/automation/` | `tests/ops/automation/` | 2 files (health, scheduler) |
| `src/decision_pipeline/` | `tests/ops/decision/` | 6 files (sim/virtual executor) |
| `src/maintenance/`, `src/backup/`, `src/retention/` | `tests/ops/maintenance/` | 3 files |
| `src/runtime/` | `tests/runtime/` | 2 files (phase1 execution route) |
| `src/qts/` | - | **누락** |
| `src/shared/` | - | **누락** |
| `src/observer_client/` | `tests/observer_client/` | 1 file (uds_client) |

### 2.3 누락 테스트 식별 (Gap Analysis)

| 우선순위 | 소스 모듈 | 누락 항목 | 필요 테스트 |
|---------|----------|----------|-----------|
| **P0** | `src/qts/core/` | 핵심 비즈니스 로직 테스트 없음 | unit tests for core logic |
| **P0** | `src/shared/` | 공유 유틸리티 테스트 없음 | unit tests for utilities |
| **P1** | `src/strategy/engines/` | 엔진 구현체 직접 테스트 부족 | engine-level tests |
| **P1** | `src/risk/policies/` | 리스크 정책 테스트 없음 | policy validation tests |
| **P1** | `src/pipeline/adapters/` | 파이프라인 어댑터 테스트 | adapter contract tests |
| **P2** | `src/provider/failsafe/` | 브로커 페일세이프 테스트 | failsafe scenario tests |
| **P2** | `src/strategy/arbitration/` | 전략 중재 테스트 | arbitration logic tests |

## 3. 상세 설계 (Detailed Design)

### 3.1 FR-01: 테스트 현황 분석

**구현 방식**: pytest 실행 + coverage 수집

```bash
# 전체 테스트 실행 및 커버리지 측정
pytest tests/ --cov=src --cov-report=html --cov-report=term-missing -v

# 빠른 테스트만 실행 (외부 의존성 제외)
pytest tests/ -m "not integration and not api" --cov=src -v
```

**출력물**: 커버리지 리포트 (htmlcov/), 테스트 결과 요약

### 3.2 FR-02: 누락 테스트 케이스 추가

**구현 순서**:

1. `tests/unit/test_shared_utils.py` - 공유 유틸리티 테스트
2. `tests/unit/test_qts_core.py` - 핵심 비즈니스 로직 테스트
3. `tests/engines/test_risk_policies.py` - 리스크 정책 테스트
4. `tests/engines/test_strategy_engines.py` - 전략 엔진 구현체 테스트
5. `tests/contracts/test_pipeline_adapter_contracts.py` - 어댑터 계약 테스트

**테스트 패턴**:

```python
# 표준 단위 테스트 패턴
class TestModuleName:
    """모듈명 단위 테스트."""

    def test_기능_정상_동작(self):
        """정상 입력에 대한 기대 출력 검증."""
        pass

    def test_기능_경계값(self):
        """경계값 테스트."""
        pass

    def test_기능_예외_처리(self):
        """예외 상황 테스트."""
        pass
```

```python
# 비동기 테스트 패턴
import pytest

class TestAsyncModule:
    """비동기 모듈 테스트."""

    @pytest.mark.asyncio
    async def test_async_operation(self):
        """비동기 작업 테스트."""
        pass
```

### 3.3 FR-03: 테스트 자동화 파이프라인

**CI 파이프라인 설계**:

```yaml
# .github/workflows/test.yml 구조
name: QTS Tests
on: [push, pull_request]
jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - pytest tests/ -m "not integration and not api" --cov=src

  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - pytest tests/integration/ -v

  contract-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - pytest tests/contracts/ -v
```

### 3.4 FR-04: 커버리지 기준

| 대상 | 목표 커버리지 | 근거 |
|------|------------|------|
| `src/safety/` | 90%+ | Safety Layer - 최우선 |
| `src/risk/` | 90%+ | 리스크 관리 핵심 |
| `src/strategy/` | 90%+ | 전략 엔진 핵심 |
| `src/pipeline/` | 85%+ | ETEDA 파이프라인 |
| `src/provider/` | 80%+ | 브로커 어댑터 |
| `src/db/` | 80%+ | 데이터 레이어 |
| 기타 | 70%+ | 유틸리티/보조 |
| **전체** | **80%+** | NFR-02 기준 |

## 4. Mock 전략 (Mocking Strategy)

### 기존 Mock 구현

| Mock | 위치 | 용도 |
|------|------|------|
| `MockBroker` | `tests/mocks/brokers/mock_broker.py` | 브로커 API 모킹 |
| `MockSheetsClient` | `tests/mocks/db/mock_sheets_client.py` | Google Sheets 모킹 |
| `MockSafetyHook` | `tests/mocks/pipeline/mock_safety_hook.py` | Safety 파이프라인 모킹 |
| `MockSnapshotSource` | `tests/mocks/pipeline/mock_snapshot_source.py` | 스냅샷 소스 모킹 |
| `NoopSheetsClient` | `src/` (production code) | 로컬 실행용 Noop 클라이언트 |

### 추가 필요 Mock

| Mock | 용도 | 우선순위 |
|------|------|---------|
| `MockRiskPolicy` | 리스크 정책 테스트 격리 | P1 |
| `MockStrategyEngine` | 전략 엔진 단위 테스트 | P1 |
| `MockObserverClient` | 마켓 데이터 관찰자 모킹 | P2 |

## 5. 구현 순서 (Implementation Order)

```
Phase 1: 현황 분석 (FR-01)
├── 1.1 pytest 전체 실행 및 결과 수집
├── 1.2 coverage 리포트 생성
└── 1.3 현황 보고서 작성

Phase 2: 누락 테스트 식별 및 작성 (FR-02)
├── 2.1 src/qts/core/ 테스트 작성
├── 2.2 src/shared/ 테스트 작성
├── 2.3 src/risk/policies/ 테스트 작성
├── 2.4 src/strategy/engines/ 테스트 작성
└── 2.5 src/pipeline/adapters/ 테스트 작성

Phase 3: CI/CD 테스트 통합 (FR-03)
├── 3.1 GitHub Actions workflow 점검
├── 3.2 테스트 마커 정리 (unit, integration, api)
└── 3.3 커버리지 게이트 설정

Phase 4: 커버리지 기준 달성 (FR-04)
├── 4.1 커버리지 미달 모듈 식별
├── 4.2 추가 테스트 작성
└── 4.3 최종 커버리지 검증
```

## 6. 파일 목록 (Files to Create/Modify)

### 신규 생성

| 파일 | 용도 |
|------|------|
| `tests/unit/test_shared_utils.py` | 공유 유틸리티 테스트 |
| `tests/unit/test_qts_core.py` | 핵심 비즈니스 로직 테스트 |
| `tests/engines/test_risk_policies.py` | 리스크 정책 테스트 |
| `tests/engines/test_strategy_engines.py` | 전략 엔진 구현체 테스트 |
| `tests/contracts/test_pipeline_adapter_contracts.py` | 어댑터 계약 테스트 |

### 수정 대상

| 파일 | 수정 내용 |
|------|----------|
| `tests/conftest.py` | 테스트 마커 추가 (unit, integration, api, slow) |
| `pyproject.toml` 또는 `pytest.ini` | 마커 등록, 커버리지 설정 |
| `.github/workflows/*.yml` | CI 테스트 파이프라인 업데이트 (있는 경우) |

## 7. 성공 기준 (Acceptance Criteria)

- [ ] AC-01: `pytest tests/` 전체 통과율 100%
- [ ] AC-02: 전체 코드 커버리지 80% 이상
- [ ] AC-03: Safety/Risk/Strategy 엔진 커버리지 90% 이상
- [ ] AC-04: 누락된 핵심 모듈(qts/core, shared) 테스트 추가 완료
- [ ] AC-05: 테스트 마커 체계 정립 (unit/integration/api/slow)
- [ ] AC-06: 전체 테스트 실행 시간 5분 이내

---

> **Next**: `/pdca do 테스트-작업` 으로 구현을 시작합니다.
