# PDCA Plan: 스캘프-실행

## Feature Overview
- **Feature Name**: 스캘프-실행 (Scalp Execution Micro-Architecture)
- **Phase**: Pipeline Phase 4/6
- **Priority**: High
- **Architecture Reference**: `docs/arch/sub/15_Scalp_Execution_Micro_Architecture.md`

## Problem Statement
ETEDA 파이프라인의 Act 단계를 Scalp 전략 전용으로 확장하여 6단계 실행 파이프라인을 구현해야 한다.
현재 `src/provider/`에 기본 브로커 인터페이스가 있지만, 주문 분할, 부분 체결 모니터링,
적응적 가격 조정, 긴급 탈출 등 Scalp 실행에 필요한 세부 로직이 없다.

## Scope

### In Scope
- 6단계 실행 파이프라인 (PreCheck → OrderSplit → AsyncSend → PartialFillMonitor → AdaptiveAdjust → EmergencyEscape)
- 실행 상태 머신 (10 states, 전이 규칙)
- 비동기 브로커 인터페이스 (Protocol 기반)
- Safety 연계 (FS090-FS095, GR060-GR064)
- 실행 파이프라인 오케스트레이터
- 단계별 타임아웃 처리
- 기존 `src/provider/` 모델 재사용 (OrderSide, OrderType 등)

### Out of Scope
- 실제 브로커 API 통신 (Mock으로 대체)
- Redis 캐싱 통합 (Phase 2에서 인프라 구축됨, 실제 연결은 별도)
- VWAP/TWAP 실시간 거래량 프로파일 (Stub으로 대체)
- 레이턴시 스트레스 테스트 (구조적 테스트만)

## Success Criteria
- [ ] 6단계 파이프라인 각 Stage가 독립 테스트 가능
- [ ] 상태 머신 전이 규칙 100% 검증
- [ ] Safety 코드 (FS090-FS095, GR060-GR064) 구현 및 테스트
- [ ] Emergency Escape가 모든 비종료 상태에서 실행 가능
- [ ] 기존 provider 모델과 호환
- [ ] 전체 테스트 통과율 100%
- [ ] Phase 1-3 회귀 테스트 통과

## Implementation Order
1. `src/execution/contracts.py` — 실행 데이터 계약
2. `src/execution/state_machine.py` — 상태 머신 + 전이 규칙
3. `src/execution/stages/precheck.py` — Stage 1: PreCheck
4. `src/execution/stages/order_split.py` — Stage 2: OrderSplit
5. `src/execution/stages/async_send.py` — Stage 3: AsyncSend
6. `src/execution/stages/fill_monitor.py` — Stage 4: PartialFillMonitor
7. `src/execution/stages/adaptive_adjust.py` — Stage 5: AdaptiveAdjust
8. `src/execution/stages/emergency_escape.py` — Stage 6: EmergencyEscape
9. `src/execution/guardrails.py` — 실행 가드레일 + Fail-Safe
10. `src/execution/pipeline.py` — 파이프라인 오케스트레이터

## Dependencies
- `src/provider/models/` — OrderSide, OrderType, OrderRequest, OrderResponse, OrderStatus
- `src/event/contracts.py` — EventType, EventPriority, create_event
- `src/safety/state.py` — SafetyState, SafetyStateManager
- `src/capital/contracts.py` — PoolId, CapitalPoolContract (자본 가용성 확인)

## Risk & Mitigation
| Risk | Impact | Mitigation |
|------|--------|------------|
| 비동기 테스트 복잡성 | Medium | asyncio.run() 래퍼, 동기 인터페이스 제공 |
| 브로커 의존성 | High | Protocol 기반 인터페이스, Mock 구현 |
| 상태 머신 복잡도 | Medium | 독립 테스트, 전이 매트릭스 검증 |
