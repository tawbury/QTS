# PDCA Design: 스캘프-실행

## Architecture Overview

```
ETEDA Decide Phase
    │ OrderDecision (Scalp)
    ▼
┌──────────────────────────────────────────────────────┐
│            SCALP EXECUTION PIPELINE                    │
│                                                        │
│  PreCheck → OrderSplit → AsyncSend → PartialFill →   │
│             AdaptiveAdjust → EmergencyEscape           │
│                                                        │
│  ExecutionStateMachine: 10 states, 전이 규칙 관리     │
│  ExecutionGuardrails: GR060-064, FS090-095            │
└──────────────────────────────────────────────────────┘
    │
    ▼
ExecutionResult → Event System (P0)
```

## Source Files (10)

| # | File | Purpose |
|---|------|---------|
| 1 | `src/execution/__init__.py` | 패키지 초기화 |
| 2 | `src/execution/contracts.py` | 실행 데이터 계약 (ExecutionState, OrderDecision, SplitOrder, FillEvent 등) |
| 3 | `src/execution/state_machine.py` | 상태 머신 (10 states, 전이 규칙, 타임아웃) |
| 4 | `src/execution/stages/precheck.py` | Stage 1: 전제 조건 검증 |
| 5 | `src/execution/stages/order_split.py` | Stage 2: 주문 분할 (Single/TWAP/VWAP/Iceberg) |
| 6 | `src/execution/stages/async_send.py` | Stage 3: 비동기 전송 + 재시도 |
| 7 | `src/execution/stages/fill_monitor.py` | Stage 4: 부분 체결 모니터링 |
| 8 | `src/execution/stages/adaptive_adjust.py` | Stage 5: 적응적 가격 조정 |
| 9 | `src/execution/stages/emergency_escape.py` | Stage 6: 긴급 탈출 |
| 10 | `src/execution/guardrails.py` | 실행 가드레일 (GR060-064) + Fail-Safe (FS090-095) |
| 11 | `src/execution/pipeline.py` | 파이프라인 오케스트레이터 |

## Test Files (9)

| # | File | Tests |
|---|------|-------|
| 1 | `tests/unit/execution/__init__.py` | 패키지 초기화 |
| 2 | `tests/unit/execution/test_contracts.py` | 계약 검증 |
| 3 | `tests/unit/execution/test_state_machine.py` | 상태 머신 전이 규칙 |
| 4 | `tests/unit/execution/test_precheck.py` | PreCheck Stage |
| 5 | `tests/unit/execution/test_order_split.py` | OrderSplit Stage |
| 6 | `tests/unit/execution/test_async_send.py` | AsyncSend Stage |
| 7 | `tests/unit/execution/test_fill_monitor.py` | FillMonitor Stage |
| 8 | `tests/unit/execution/test_guardrails.py` | 가드레일 + Fail-Safe |
| 9 | `tests/integration/test_execution_integration.py` | 전체 파이프라인 통합 |

## Data Contracts

### ExecutionState (10 states)
```python
class ExecutionState(str, Enum):
    INIT = "INIT"
    PRECHECK = "PRECHECK"
    SPLITTING = "SPLITTING"
    SENDING = "SENDING"
    MONITORING = "MONITORING"
    ADJUSTING = "ADJUSTING"
    ESCAPING = "ESCAPING"
    COMPLETE = "COMPLETE"
    ESCAPED = "ESCAPED"
    FAILED = "FAILED"
```

### OrderDecision (파이프라인 입력)
```python
@dataclass
class OrderDecision:
    symbol: str
    side: OrderSide       # reuse from provider.models
    qty: int
    price: Optional[Decimal]
    order_type: OrderType  # reuse from provider.models
    strategy_id: str = ""
    urgency: str = "NORMAL"  # NORMAL / URGENT
```

### SplitOrder (분할 주문)
```python
@dataclass
class SplitOrder:
    split_id: str
    parent_order_id: str
    sequence: int
    qty: int
    price: Optional[Decimal]
    price_type: OrderType
    status: str = "PENDING"  # PENDING / SENT / FILLED / PARTIALLY_FILLED / CANCELLED / FAILED
    broker_order_id: str = ""
    filled_qty: int = 0
    avg_fill_price: Optional[Decimal] = None
```

### ExecutionAlert (Safety)
```python
@dataclass(frozen=True)
class ExecutionAlert:
    code: str          # FS090-095 or GR060-064
    severity: str      # FAIL_SAFE / GUARDRAIL / WARNING
    message: str
    stage: str = ""
```

## State Transition Rules
```
INIT        → [PRECHECK]
PRECHECK    → [SPLITTING, FAILED, ESCAPING]
SPLITTING   → [SENDING, FAILED, ESCAPING]
SENDING     → [MONITORING, FAILED, ESCAPING]
MONITORING  → [COMPLETE, ADJUSTING, ESCAPING]
ADJUSTING   → [MONITORING, ESCAPING]
ESCAPING    → [ESCAPED]
COMPLETE    → []  (terminal)
ESCAPED     → []  (terminal)
FAILED      → []  (terminal)

Emergency rule: Any non-terminal → ESCAPING
```

## Stage Timeouts
```python
STAGE_TIMEOUTS_MS = {
    "PRECHECK": 5000,
    "SPLITTING": 1000,
    "SENDING": 10000,
    "MONITORING": 60000,
    "ADJUSTING": 30000,
    "ESCAPING": 30000,
}
```

## Split Strategies
| Strategy | Condition | Algorithm |
|----------|-----------|-----------|
| SINGLE | qty <= min_split_qty (default 100) | 분할 없이 단일 주문 |
| TWAP | 시간 균등 분할 | qty / num_buckets |
| VWAP | 거래량 가중 분할 | volume_profile × qty |
| ICEBERG | 호가창 노출 최소화 | visible_qty + hidden remainder |

## Safety Codes

### Fail-Safe (FS090-FS095)
| Code | Trigger | Action |
|------|---------|--------|
| FS090 | 전송 전체 실패 | 실행 중단, FAILED 전이 |
| FS091 | 잘못된 종목 | 실행 중단, FAILED 전이 |
| FS092 | Emergency Escape 실행 | 로그 + Safety 통보 |
| FS093 | 체결 타임아웃 | 미체결 취소 |
| FS094 | 슬리피지 초과 | 조정 중단 |
| FS095 | P0 큐 오버플로우 | 실행 일시 정지 |

### Guardrails (GR060-GR064)
| Code | Trigger | Action |
|------|---------|--------|
| GR060 | 분할 주문 과다 (>20) | 분할 수 제한 |
| GR061 | 잔고 부족 | 수량 축소 |
| GR062 | 일일 거래 한도 | 추가 거래 차단 |
| GR063 | 슬리피지 경고 (>0.3%) | 가격 조정 제한 |
| GR064 | 체결 지연 (>30s) | 경고 로그 |

## Integration Points

### Existing Modules (reuse)
- `src/provider/models/order_request.py` → OrderSide, OrderType
- `src/provider/models/order_response.py` → OrderStatus
- `src/event/contracts.py` → EventType, create_event
- `src/safety/state.py` → SafetyState
- `src/capital/contracts.py` → PoolId, CapitalPoolContract

### Protocol-based Broker Interface
```python
class AsyncBrokerProtocol(Protocol):
    async def send_order(self, symbol, side, qty, price, order_type) -> OrderAck: ...
    async def modify_order(self, order_id, new_price, new_qty) -> ModifyAck: ...
    async def cancel_order(self, order_id) -> CancelAck: ...
```
