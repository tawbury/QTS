# Plan: 자금-관리 (Capital Flow Architecture)

## Feature Overview
- **Phase**: 3/6 (아키텍처 고도화 파이프라인)
- **Architecture Doc**: `docs/arch/sub/14_Capital_Flow_Architecture.md`
- **Scope**: 3-Track Capital Pool 모델, 자본 배분, 프로모션/디모션, Capital Engine

## Problem Statement
QTS는 Scalp/Swing/Portfolio 세 가지 자본 풀을 규칙 기반으로 관리해야 한다.
현재 자본 관리 모듈이 없어 풀 수준 배분, 프로모션(승급), 디모션(강등) 로직이 부재하다.

## Success Criteria
- [ ] CapitalPoolContract 데이터 모델 구현
- [ ] OperatingState 기반 동적 배분 (AGGRESSIVE/BALANCED/DEFENSIVE)
- [ ] Scalp→Swing, Swing→Portfolio 프로모션 규칙
- [ ] MDD 기반 디모션 규칙
- [ ] Capital Engine (evaluate 메서드)
- [ ] Safety 연계 (GR050-GR055 Guardrails, FS080-FS085 Fail-Safe)
- [ ] 긴급 자본 잠금 (Emergency Capital Lock)
- [ ] 단위 테스트 80+ 개, 통합 테스트 포함
- [ ] Match Rate >= 90%

## Implementation Order
1. `src/capital/contracts.py` — 데이터 계약 (PoolId, PoolState, CapitalPoolContract 등)
2. `src/capital/pool.py` — CapitalPool 클래스 (개별 풀 관리)
3. `src/capital/allocator.py` — CapitalAllocator (OperatingState 기반 배분)
4. `src/capital/promotion.py` — PromotionEngine (프로모션/디모션)
5. `src/capital/engine.py` — CapitalEngine (메인 오케스트레이터)
6. `src/capital/guardrails.py` — 가드레일 & 페일세이프
7. 단위 테스트 (contracts, pool, allocator, promotion, engine, guardrails)
8. 통합 테스트 (Capital + State + Safety + Event 연계)

## Dependencies
- Phase 1: `src/event/contracts.py` (EventType, EventPriority)
- Phase 1: `src/state/contracts.py` (OperatingState, STATE_PROPERTIES)
- Phase 1: `src/safety/state.py` (SafetyState, SafetyStateManager)
- Phase 2: `src/db/contracts.py` (Position, LedgerEntry)

## Risk & Mitigation
- **Risk**: 프로모션 계산 시 부동소수점 오차 → Decimal 사용
- **Risk**: 풀 합계 ≠ 100% → GR050 가드레일로 정규화
- **Risk**: 동시 프로모션/디모션 충돌 → 잠금(lock) 메커니즘
