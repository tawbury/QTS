# Design: 자금-관리 (Capital Flow Architecture)

## Architecture Overview

```
┌─────────────────────────────────────────────────────────┐
│                    CapitalEngine                         │
│  evaluate(input) → CapitalEngineOutput                  │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ CapitalPool  │  │ Allocator    │  │ Promotion    │  │
│  │ (Scalp)      │  │ (Operating   │  │ Engine       │  │
│  │              │  │  State 기반) │  │ (승급/강등)  │  │
│  ├──────────────┤  └──────────────┘  └──────────────┘  │
│  │ CapitalPool  │                                       │
│  │ (Swing)      │  ┌──────────────┐                    │
│  ├──────────────┤  │ Guardrails   │                    │
│  │ CapitalPool  │  │ (GR050-055)  │                    │
│  │ (Portfolio)  │  │ FS080-085    │                    │
│  └──────────────┘  └──────────────┘                    │
│                                                          │
└─────────────────────────────────────────────────────────┘
       ↑                    ↑                    ↑
  OperatingState       SafetyState          EventSystem
  (Phase 1)            (Phase 1)            (Phase 1)
```

## 1. Data Contracts (`src/capital/contracts.py`)

### PoolId Enum
```python
class PoolId(str, Enum):
    SCALP = "SCALP"
    SWING = "SWING"
    PORTFOLIO = "PORTFOLIO"
```

### PoolState Enum
```python
class PoolState(str, Enum):
    ACTIVE = "ACTIVE"
    PAUSED = "PAUSED"
    LOCKED = "LOCKED"
```

### CapitalPoolContract
```python
@dataclass
class CapitalPoolContract:
    pool_id: PoolId
    total_capital: Decimal
    available_capital: Decimal
    invested_capital: Decimal
    reserved_capital: Decimal = Decimal("0")
    realized_pnl: Decimal = Decimal("0")
    unrealized_pnl: Decimal = Decimal("0")
    accumulated_profit: Decimal = Decimal("0")
    allocation_pct: Decimal = Decimal("0")
    target_allocation_pct: Decimal = Decimal("0")
    pool_state: PoolState = PoolState.ACTIVE
    last_promotion_at: Optional[datetime] = None
```

### PromotionCriteria, DemotionRule, AllocationConstraints
- Scalp→Swing: min_profit 100만, min_sharpe 1.5, min_win_rate 55%, min_trades 50, max_mdd 10%
- Swing→Portfolio: min_profit 500만, min_sharpe 1.2, max_mdd 15%
- Demotion: Portfolio MDD>10% → 20% to Swing, Swing MDD>15% → 30% to Scalp

### CapitalTransfer (이전 기록)
```python
@dataclass(frozen=True)
class CapitalTransfer:
    from_pool: PoolId
    to_pool: PoolId
    amount: Decimal
    reason: str
    timestamp: datetime
```

### CapitalAlert
```python
@dataclass(frozen=True)
class CapitalAlert:
    code: str          # GR050~GR055, FS080~FS085
    pool_id: Optional[PoolId]
    message: str
    severity: str      # "WARNING" | "CRITICAL"
    timestamp: datetime
```

## 2. CapitalPool (`src/capital/pool.py`)

개별 풀 상태 관리:
- `available_capital` = total - invested - reserved
- `is_valid()`: invested <= total, 음수 없음
- `lock(reason)` / `unlock()`: 풀 잠금
- `apply_transfer(amount, direction)`: 자본 이동 적용

## 3. CapitalAllocator (`src/capital/allocator.py`)

OperatingState 기반 목표 배분 계산:
- `calculate_target_allocation(state, total_equity)` → dict[PoolId, Decimal]
- STATE_PROPERTIES의 allocation_range 중간값 사용
- 제약조건: min_pct, max_pct, min_amount 적용
- 정규화: 합계 100% 보장

## 4. PromotionEngine (`src/capital/promotion.py`)

프로모션/디모션 판단:
- `check_scalp_to_swing(pool, metrics)` → Optional[Decimal]
- `check_swing_to_portfolio(pool, metrics)` → Optional[Decimal]
- `check_portfolio_demotion(pool, metrics)` → Optional[Decimal]
- `check_swing_demotion(pool, metrics)` → Optional[Decimal]

### PerformanceMetrics
```python
@dataclass(frozen=True)
class PerformanceMetrics:
    sharpe_ratio: float = 0.0
    win_rate_30d: float = 0.0
    trades_30d: int = 0
    mdd_30d: float = 0.0
    mdd_90d: float = 0.0
    consecutive_losses: int = 0
    holding_period_avg: float = 0.0
```

## 5. CapitalEngine (`src/capital/engine.py`)

메인 오케스트레이터:
```python
class CapitalEngine:
    def evaluate(self, input: CapitalEngineInput) -> CapitalEngineOutput:
        1. calculate_target_allocation (Allocator)
        2. check_promotions (PromotionEngine)
        3. check_demotions (PromotionEngine)
        4. check_rebalancing
        5. generate_alerts (Guardrails)
```

### CapitalEngineInput / Output
- Input: total_equity, operating_state, pool_states, performance_metrics, safety_state
- Output: allocation_decision, pending_promotions, pending_demotions, rebalancing_required, alerts

## 6. Guardrails (`src/capital/guardrails.py`)

| Code | Check | Action |
|------|-------|--------|
| GR050 | 풀 합계 ≠ 100% | 자동 정규화 |
| GR051 | min_pct 미달 | 경고 |
| GR052 | max_pct 초과 | 프로모션 차단 |
| GR053 | 이전액 > 가용 자본 | 축소 |
| GR054 | 일일 이동 한도 초과 | 지연 |
| GR055 | 드리프트 > 10% | 리밸런싱 권고 |
| FS080 | 총 자본 <= 0 | LOCKDOWN |
| FS081 | 풀 자본 음수 | 풀 잠금 |
| FS082 | 풀 MDD > 20% | 풀 잠금 |
| FS083 | 비정상 자본 변동 | 모든 이동 중단 |

## 7. File List

### Source
- `src/capital/__init__.py`
- `src/capital/contracts.py`
- `src/capital/pool.py`
- `src/capital/allocator.py`
- `src/capital/promotion.py`
- `src/capital/engine.py`
- `src/capital/guardrails.py`

### Tests
- `tests/unit/capital/__init__.py`
- `tests/unit/capital/test_contracts.py`
- `tests/unit/capital/test_pool.py`
- `tests/unit/capital/test_allocator.py`
- `tests/unit/capital/test_promotion.py`
- `tests/unit/capital/test_engine.py`
- `tests/unit/capital/test_guardrails.py`
- `tests/integration/test_capital_integration.py`

## 8. Integration Points

- `src/state/contracts.py` → OperatingState, STATE_PROPERTIES (배분 범위)
- `src/event/contracts.py` → EventType (CAPITAL_PROMOTION 등 추가 가능)
- `src/safety/state.py` → SafetyState, SafetyStateManager (LOCKDOWN 시 풀 잠금)
