version: '3.8'

services:
  observer:
    build:
      context: ../../prj_obs
      dockerfile: docker/Dockerfile
    image: observer-test:latest
    container_name: observer-test
    environment:
      - RUN_MODE=container
      - OBSERVER_DATA_DIR=/opt/platform/runtime/observer/data
      - OBSERVER_ASSETS_DIR=/opt/platform/runtime/observer/data
      # Force data generation on startup
      - GENERATE_TEST_DATA=true
    volumes:
      - observer-data:/opt/platform/runtime/observer/data
      - ../ops/test_tools/generate_mock_files.py:/opt/generator.py
    # Run the mock data generator script
    command: python /opt/generator.py

  qts:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: qts-test:latest
    container_name: qts-test
    environment:
      - RUN_MODE=container
      - OBSERVER_ASSETS_DIR=/opt/platform/runtime/qts/data/observer_assets
      - OBSERVER_TYPE=file
      - LIVE_ENABLED=false
      - TRADING_ENABLED=true
    volumes:
      # Mount the observer's data volume to QTS's expected location
      - observer-data:/opt/platform/runtime/qts/data/observer_assets:ro
      # Mount local config for preflight check / runtime config
      - ../config:/opt/platform/qts/config:ro
    depends_on:
      - observer
    # Run the application in file-observer mode
    command: python -m app.main --local-only --env development --verbose
    # command: tail -f /dev/null

volumes:
  observer-data:
